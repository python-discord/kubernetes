apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
    spec:
      containers:
      - image: prom/alertmanager:latest
        imagePullPolicy: Always
        name: alertmanager
        args: [
          "--config.file=/opt/pydis/alertmanager/config.d/alertmanager.yaml",
          "--web.external-url=https://alertmanager.pythondiscord.com",
          "--storage.path=/data/alertmanager"
        ]
        ports:
        - name: alertmanager
          containerPort: 9093
        volumeMounts:
        - name: alertmanager-config
          mountPath: /opt/pydis/alertmanager/config.d
        - name: alertmanager-webhooks
          mountPath: /opt/pydis/alertmanager/webhooks
        - name: alertmanager-tmp-data
          mountPath: /data
        securityContext:
          readOnlyRootFilesystem: true
      restartPolicy: Always
      volumes:
        - name: alertmanager-config
          configMap:
            name: alertmanager-config
        - name: alertmanager-webhooks
          secret:
            secretName: alert-manager-hook
        - name: alertmanager-tmp-data
          emptyDir: {}
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsNonRoot: true
